# User Roles Permission System - Fix Documentation

## Problem Identified

The user roles permission system in Settings.tsx was not functioning correctly. Users could toggle permissions for roles (like "Member" accessing "Dashboard"), but these changes had no effect on actual access control.

### Root Cause

The Dashboard component (`src/pages/Dashboard/Dashboard.tsx`) was using a **hardcoded** `ROLE_ACCESS` object instead of reading permissions from the database:

```typescript
// OLD - Hardcoded permissions (REMOVED)
const ROLE_ACCESS: Record<string, string[]> = {
    'administrator': ['Dashboard', 'Attendance', 'Members', 'Reservation', 'Reports', 'Settings', 'My Profile'],
    'ministry leader': ['Attendance', 'Members', 'Reports', 'My Profile'],
    'logistics': ['Reservation', 'My Profile'],
    'member': ['My Profile', 'Attendance'],
    'volunteer': ['My Profile', 'Attendance']
};
```

This meant that:
1. Settings page allowed admins to modify role permissions in the database
2. But Dashboard ignored those database permissions and used hardcoded values
3. Result: Permission changes had no effect

## Solution Implemented

### 1. Removed Hardcoded Permissions
Deleted the `ROLE_ACCESS` constant entirely.

### 2. Added Dynamic Permission Fetching
Added a new `useEffect` hook that:
- Fetches the user's role from their profile
- Queries the `roles` table for that role's permissions
- Stores the permissions in state (`allowedTabs`)
- Always ensures "My Profile" is accessible as a fallback

```typescript
// NEW - Dynamic permission fetching
useEffect(() => {
    const fetchRolePermissions = async () => {
        if (!profile) return;

        try {
            setIsLoadingPermissions(true);
            const userRole = profile.role || 'Member';

            // Fetch the role's permissions from the database
            const { data: roleData, error } = await supabase
                .from('roles')
                .select('permissions')
                .eq('name', userRole)
                .single();

            if (error) {
                console.error('Error fetching role permissions:', error);
                setAllowedTabs(['My Profile']);
                return;
            }

            const permissions = roleData?.permissions || [];
            const tabs = permissions.length > 0 ? permissions : ['My Profile'];
            
            // Always ensure My Profile is accessible
            if (!tabs.includes('My Profile')) {
                tabs.push('My Profile');
            }

            setAllowedTabs(tabs);
        } catch (error) {
            console.error('Error in fetchRolePermissions:', error);
            setAllowedTabs(['My Profile']);
        } finally {
            setIsLoadingPermissions(false);
        }
    };

    if (!loading && profile) {
        fetchRolePermissions();
    }
}, [profile, loading]);
```

### 3. Updated Tab Initialization Logic
Modified the useEffect that sets the initial active tab to wait for permissions to load:

```typescript
// Set initial active tab when permissions are loaded
useEffect(() => {
    if (!isLoadingPermissions && allowedTabs.length > 0) {
        if (!activeTab || !allowedTabs.includes(activeTab)) {
            setActiveTab(allowedTabs[0]);
        }
    }
}, [isLoadingPermissions, allowedTabs, activeTab]);
```

## How It Works Now

1. **User logs in** → Profile loaded with their role (e.g., "Member")
2. **Dashboard fetches permissions** → Queries `roles` table for "Member" role's permissions
3. **Permissions applied** → Only shows navigation items that are in the permissions array
4. **Settings changes work** → When admin toggles permissions in Settings, they immediately affect access on next page load

## Database Schema

The `roles` table structure:
```sql
create table if not exists public.roles (
    id bigint generated by default as identity primary key,
    name text not null unique,
    description text,
    permissions text[], -- Array of page names: ['Dashboard', 'Members', etc.]
    created_at timestamp with time zone default timezone('utc'::text, now()) not null
);
```

## Testing the Fix

1. **As Admin:**
   - Go to Settings → User Roles
   - Select a role (e.g., "Member")
   - Toggle permissions (e.g., enable "Dashboard")
   - Click "Save Changes"

2. **As Member:**
   - Log out and log in as a member
   - Check sidebar - should now see "Dashboard" if permission was granted
   - Try accessing the page - should work

3. **Verify:**
   - Open browser console
   - Look for log: `User role: Member, Permissions: ['Dashboard', 'My Profile', ...]`
   - This confirms permissions are being fetched from database

## Files Modified

- `src/pages/Dashboard/Dashboard.tsx`
  - Removed hardcoded `ROLE_ACCESS` constant
  - Added `allowedTabs` state
  - Added `isLoadingPermissions` state
  - Added `fetchRolePermissions` useEffect
  - Updated tab initialization logic

## Notes

- **Fallback behavior:** If role not found in database, defaults to `['My Profile']` only
- **Always accessible:** "My Profile" is always added to permissions as a safety measure
- **Case sensitivity:** Role names are case-sensitive (must match exactly between `profiles.role` and `roles.name`)
- **Console logging:** Added debug logs to help troubleshoot permission issues

## Future Improvements

Consider:
1. Adding a loading state indicator while permissions are being fetched
2. Caching permissions to reduce database queries
3. Adding real-time updates when permissions change (using Supabase realtime)
4. Adding permission checks at the route level for additional security
